version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: kellyflo-portfolio-backend
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - DB_URL=jdbc:h2:file:./data/kellyflo_portfolio;MODE=MySQL;AUTO_SERVER=TRUE
      - DB_USERNAME=sa
      - DB_PASSWORD=
      - JPA_DDL_AUTO=update
      - JPA_SHOW_SQL=false
      - H2_CONSOLE_ENABLED=true
      - JWT_SECRET=${JWT_SECRET:-replace-with-a-long-random-secret-of-at-least-32-characters}
      - JWT_EXPIRATION_MS=86400000
      - CORS_ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000
      - MAIL_TO=${MAIL_TO:-kelly123simiyu@gmail.com}
      - MAIL_FROM=${MAIL_FROM:-no-reply@kellyflo.dev}
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - APP_ADMIN_USERNAME=${APP_ADMIN_USERNAME:-admin}
      - APP_ADMIN_PASSWORD=${APP_ADMIN_PASSWORD:-Admin@12345}
      - APP_ADMIN_EMAIL=${APP_ADMIN_EMAIL:-admin@kellyflo.dev}
      - UPLOAD_DIR=/app/uploads
    volumes:
      - ./backend/data:/app/data
      - ./backend/uploads:/app/uploads
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/public/content"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  backend-data:
  backend-uploads:
